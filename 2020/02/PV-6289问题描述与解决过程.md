# PV-6289 bug复盘：JobEngine中的任务状态修改与job执行后的状态上报不同步导致的用户端无法正常显示历史任务和事件的问题（ParaStor版本: 3.1.2）

## 问题描述：
在ABC三节点组成的集群中执行**磁盘巡检**操作，（确切的讲是下发需要jobEngine执行的job）当任务下发后，执行对A节点的数据网断网操作，等待该任务执行完毕后，现象为：实时任务列表没有该任务，历史任务列表也没有该任务，且在相当长的一段时间内，无法在事件中查找到该磁盘巡检事件。当对A节点的数据网进行恢复后，事件产生，历史任务中也可以查找到该事件。

## 现象分析：
此问题产生在人为做故障后产生：故障为断开一个节点的数据网。产生的现象为：断网期间无法查找到事件和历史任务，只有在数据网恢复后，事件才能产生。因此猜测该问题的出现跟++数据网断网以及oJob模块++有必然联系。

## 查看问题定位备注以及评审记录：
通过查看**PV-6289**的备注信息可以知道，此问题产生的原因是ojob模块的任务状态上报和mgr模块的任务状态显示不一致，导致从用户端看到的任务状态与实际的任务状态不同，而故障刚好将任务状态卡在了两个状态的切换直接，导致任务既不在实时任务列表中，又不在历史任务列表中，历史任务列表是根据事件来生成的，如果有故障导致事件不能生成，那么其对应的历史任务必然也不能出现。
因此，此问题需要理顺ojob与webui端的数据传递过程。

## 问题分析：
通过页面可以定位到实时任务列表中的任务更新是通过一个定时任务来完成的：
`getRuningAsyncJob.action`
![01.png](0)
首先梳理一下该实时任务页面显示的任务列表是如何在后退完成的：通过图片中的action
树藤摸瓜，可以定位到该方法的处理类：`JobengineAction`，同时定位到其向后端发送的指令`/system/get_runing_async_jobs`，因此我们可以定位到该方法的路由：`SystemServlet.java`和其对应的获取后台job的方法：

![02.png](1)
这个是通过`getAsyncJobs`来获取后台的异步job的
这里需要注意的是，在此处，要明确的是下发给ojob模块的任务是归属于jobengine进行上报的，而继续跟踪上面的`getAsyncJobs`方法，会进入oJmgs后台job的获取方法当中：

![04.png](2)
同时可以知道，对应的异步job被缓存在`ayncJobCacheMap`对象中
通过`AsyncJobEnum.java`可知，目前可以获取到异步job的模块就四个：
`MGR, JOB_ENGINE, HSM, REVERT_SNAPSHOT, REP`
而这里要获取的却是`JOB_ENGINE`中的后台任务，因此需要明确`JOB_ENGINE`中的任务时何时更新进去的，从前面的代码中，可以看到：

![03.png](3)
在`init`方法中，有对jobengine的更新，而此init方法是在`ManageServer.java`中任务运行之前进行初始化的：

![06.png](4)
因此，在初始化时，就对jobengine中的job进行了更新。继续跟踪该jobengine中对应的方法，即可查到获取jobengine中的job视图的处理方法：
 ![07.png](5)
在`getRunningJobEngineViews()`方法中，可以看到此方法只返回了：
![08.png](6)
active，wait， pause 三种状态的任务。

至此，ojob的消息上报流程也逐渐清晰，在于ojob模块同时沟通后，问题的出处也就定位出来：

1. ABC三节点开始执行磁盘巡检任务，在A节点的磁盘巡检任务开始之后，断掉A节点的数据网。
2. BC两个节点组成集群，同时置A节点为孤立，那么jobMonitor将不再收集A节点的上报信息。
3. 当B,C两个节点的磁盘巡检任务执行完毕后，由于jobMonitor不再收集A节点的信息，那么ojob会把该磁盘巡检任务的进度置为100% FINISH状态，而实时任务中并没有查找状态为finish的job，因此实时任务中是不会显示该任务信息的。
4. 对于ojmg而言，只有收到ojob上报mgr任务状态为“完成”时，才会去生成任务对应的事件，然后进行mysql中的事件与rockDB中的事件的同步操作，最后才会根据事件生成历史任务列表中的任务。
5. 而由于前面对A节点进行了断网，而磁盘巡检任务结束时ojob需要给每个节点下发任务取消指令(包括A节点)，在ojob下发磁盘巡检任务结束的命令(cancel)时，由于A无法收到来自主节点下发的命令，主节点就会一直进行重试，因此也就一直无法上报ojmgs任务完成，从而无法生成事件，历史列表中也没有对应的任务。
6. 当A节点的数据网恢复时，cancel命令得到正确响应ojob才上报任务完成，事件也就能够产生。

## 修改建议
审核中建议将查找到job_engine中的任务为100% finish状态的任务也显示在实时任务列表中，如果使用此修改方案，只需将状态为FINISH的job也加入到查找列表中即可：
![09.png](2)
但是从用户的角度来看，一个任务执行到100%, 就是执行完毕，如同进行文件下载一样，100%的任务一直存在与实时任务列表中，并不是友好的显示方式。

## 实际处理
在3.1.3版本中，oJob模块在执行cancel命令阶段，对命令的返回结果加入了判断，如果该命令下发节点的返回结果有误，则忽略掉这个错误节点，置任务为结束状态，这样也就避免了因为任务进度为100%时，没有上报完成而导致的实时任务和历史任务以及事件中都没有该任务的问题了。