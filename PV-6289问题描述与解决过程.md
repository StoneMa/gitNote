# JobEngine中的任务状态修改与job执行后的状态上报不同步导致的用户端无法正常显示历史任务和事件的问题（ParaStor版本: 3.1.2）

## 问题描述：
在ABC三节点组成的集群中执行**磁盘巡检**操作，（确切的讲是下发需要jobEngine执行的job）当任务下发后，执行对A节点的数据网断网操作，等待该任务执行完毕后，现象为：实时任务列表没有该任务，历史任务列表也没有该任务，且在相当长的一段时间内，无法在事件中查找到该磁盘巡检事件。当对A节点的数据网进行恢复后，事件产生，历史任务中也可以查找到该事件。

## 现象分析：
此问题产生在人为做故障后产生：故障为断开一个节点的数据网。产生的现象为：断网期间无法查找到事件和历史任务，只有在数据网恢复后，事件才能产生。因此猜测该问题的出现跟++数据网断网以及oJob模块++有必然联系。

## 问题分析：
通过页面可以定位到实时任务列表中的任务更新是通过一个定时任务来完成的：
`getRuningAsyncJob.action`

![01.png](0)
首先梳理一下该实时任务页面显示的任务列表是如何在后退完成的：通过图片中的action
树藤摸瓜，可以定位到该方法的处理类：`JobengineAction`，同时定位到其向后端发送的指令`/system/get_runing_async_jobs`，因此我们可以定位到该方法的路由：`SystemServlet.java`和其对应的获取后台job的方法：

![02.png](1)
这个是通过`getAsyncJobs`来获取后台的异步job的
这里需要注意的是，在此处，要明确的是下发给ojob模块的任务是归属于jobengine进行上报的，而继续跟踪上面的`getAsyncJobs`方法，会进入oJmgs后台job的获取方法当中：

![04.png](2)
同时可以知道，对应的异步job被缓存在`ayncJobCacheMap`对象中
通过`AsyncJobEnum.java`可知，目前可以获取到异步job的模块就四个：
`MGR, JOB_ENGINE, HSM, REVERT_SNAPSHOT, REP`
而这里要获取的却是`JOB_ENGINE`中的后台任务，因此需要明确`JOB_ENGINE`中的任务时何时更新进去的，从前面的代码中，可以看到：
![03.png](3)
在`init`方法中，有对jobengine的更新，而此init方法是在`ManageServer.java`中